<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebGPU Debug Test</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: monospace; }
        canvas { display: block; width: 800px; height: 600px; }
        #log { padding: 20px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <canvas id="canvas" width="800" height="600"></canvas>
    <div id="log"></div>

    <script type="module">
        const logDiv = document.getElementById('log');
        const originalLog = console.log;
        const originalError = console.error;

        console.log = function(...args) {
            logDiv.textContent += args.join(' ') + '\n';
            originalLog.apply(console, args);
        };

        console.error = function(...args) {
            logDiv.textContent += 'ERROR: ' + args.join(' ') + '\n';
            originalError.apply(console, args);
        };

        console.log('Testing WebGPU availability...');

        if (!navigator.gpu) {
            console.error('WebGPU not supported in this browser');
        } else {
            console.log('✓ WebGPU is available');

            const adapter = await navigator.gpu.requestAdapter();
            if (!adapter) {
                console.error('Could not get GPU adapter');
            } else {
                console.log('✓ GPU adapter obtained');
                console.log('Adapter info:', adapter);

                const device = await adapter.requestDevice();
                console.log('✓ GPU device obtained');

                const canvas = document.getElementById('canvas');
                const context = canvas.getContext('webgpu');
                const format = navigator.gpu.getPreferredCanvasFormat();

                context.configure({ device, format });
                console.log('✓ Canvas configured, format:', format);

                // Test simple shader
                const shaderCode = `
                    @vertex
                    fn vs_main(@builtin(vertex_index) i: u32) -> @builtin(position) vec4f {
                        let x = f32((i & 1u) << 1u) - 1.0;
                        let y = f32((i & 2u)) - 1.0;
                        return vec4f(x, y, 0.0, 1.0);
                    }

                    @fragment
                    fn fs_main(@builtin(position) pos: vec4f) -> @location(0) vec4f {
                        // Show position-based colors
                        return vec4f(pos.x / 800.0, pos.y / 600.0, 0.5, 1.0);
                    }
                `;

                console.log('Creating test shader...');
                const shaderModule = device.createShaderModule({ code: shaderCode });
                console.log('✓ Shader module created');

                const pipeline = device.createRenderPipeline({
                    layout: 'auto',
                    vertex: { module: shaderModule, entryPoint: 'vs_main' },
                    fragment: {
                        module: shaderModule,
                        entryPoint: 'fs_main',
                        targets: [{ format }]
                    },
                });
                console.log('✓ Pipeline created');

                function render() {
                    const encoder = device.createCommandEncoder();
                    const view = context.getCurrentTexture().createView();

                    const renderPass = encoder.beginRenderPass({
                        colorAttachments: [{
                            view,
                            clearValue: { r: 0.0, g: 0.0, b: 0.2, a: 1.0 },
                            loadOp: 'clear',
                            storeOp: 'store',
                        }],
                    });

                    renderPass.setPipeline(pipeline);
                    renderPass.draw(4);
                    renderPass.end();

                    device.queue.submit([encoder.finish()]);
                    requestAnimationFrame(render);
                }

                render();
                console.log('✓ Render loop started');
            }
        }
    </script>
</body>
</html>
