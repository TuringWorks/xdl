; ============================================================================
; XDL Cross-Validation Test Script
; ============================================================================
; Tests K-Fold, Stratified K-Fold, and Leave-One-Out cross-validation

PRINT, '========================================='
PRINT, 'Cross-Validation Utilities Test'
PRINT, '========================================='
PRINT, ''

; ============================================================================
; TEST 1: K-Fold Cross-Validation
; ============================================================================
PRINT, '--- TEST 1: K-Fold Cross-Validation ---'
PRINT, 'Testing 5-fold CV on 50 samples'

n_samples = 50
n_folds = 5

; Generate fold masks
folds = XDLML_KFOLD(n_samples, n_folds, 42, 1)

PRINT, 'Total elements in fold masks:', N_ELEMENTS(folds)
PRINT, 'Expected:', n_folds * n_samples

; Verify each fold
for fold_idx = 0, n_folds-1 do begin
    ; Extract mask for this fold
    fold_start = fold_idx * n_samples
    fold_end = fold_start + n_samples - 1

    ; Count training and validation samples
    n_train = 0
    n_val = 0

    FOR i = fold_start, fold_end do begin
        IF folds[i] eq 1.0 then n_train = n_train + 1
        IF folds[i] eq 0.0 then n_val = n_val + 1
    END
endfor

    PRINT, 'Fold', fold_idx, ': Training=', n_train, ', Validation=', n_val

    ; Validate split proportions
    IF n_val lt 9 OR n_val gt 11 then BEGIN
        PRINT, 'ERROR: Unexpected validation set size for fold', fold_idx
    ENDIF
end
endfor

PRINT, 'K-Fold test PASSED ✓'
PRINT, ''

; ============================================================================
; TEST 2: Stratified K-Fold
; ============================================================================
PRINT, '--- TEST 2: Stratified K-Fold ---'
PRINT, 'Testing stratified 3-fold on imbalanced dataset'

; Create imbalanced dataset: 30 class-0, 15 class-1, 5 class-2
y_labels = FLTARR(50)
y_labels[0:29] = 0.0   ; Class 0: 30 samples
y_labels[30:44] = 1.0  ; Class 1: 15 samples
y_labels[45:49] = 2.0  ; Class 2: 5 samples

n_folds_strat = 3
folds_strat = XDLML_STRATIFIEDKFOLD(y_labels, n_folds_strat, 42)

PRINT, 'Total elements:', N_ELEMENTS(folds_strat)

; Check class distribution in each fold's validation set
for fold_idx = 0, n_folds_strat-1 do begin
    fold_start = fold_idx * 50
    fold_end = fold_start + 49

    class_counts = FLTARR(3)
    n_val = 0

    FOR i = fold_start, fold_end do begin
        IF folds_strat[i] eq 0.0 then BEGIN  ; Validation sample
            sample_idx = i - fold_start
            class_label = ROUND(y_labels[sample_idx])
            class_counts[class_label] = class_counts[class_label] + 1
            n_val = n_val + 1
        ENDIF
    END
endfor

    PRINT, 'Fold', fold_idx, ': Val samples=', n_val, $
           ', Class distribution: [', class_counts[0], ',', $
           class_counts[1], ',', class_counts[2], ']'
end
endfor

PRINT, 'Stratified K-Fold test PASSED ✓'
PRINT, ''

; ============================================================================
; TEST 3: Leave-One-Out Cross-Validation
; ============================================================================
PRINT, '--- TEST 3: Leave-One-Out CV ---'
PRINT, 'Testing LOO on 10 samples (for speed)'

n_samples_loo = 10
folds_loo = XDLML_LEAVEONEOUT(n_samples_loo)

PRINT, 'Total elements:', N_ELEMENTS(folds_loo)
PRINT, 'Expected:', n_samples_loo * n_samples_loo

; Verify each fold has exactly 1 validation sample
all_correct = 1
for fold_idx = 0, n_samples_loo-1 do begin
    fold_start = fold_idx * n_samples_loo
    fold_end = fold_start + n_samples_loo - 1

    n_val = 0
    val_idx = -1

    FOR i = fold_start, fold_end do begin
        IF folds_loo[i] eq 0.0 then BEGIN
            n_val = n_val + 1
            val_idx = i - fold_start
        ENDIF
    END
endfor

    IF n_val ne 1 then BEGIN
        PRINT, 'ERROR: Fold', fold_idx, 'has', n_val, 'validation samples (expected 1)'
        all_correct = 0
    ENDIF

    IF val_idx ne fold_idx then BEGIN
        PRINT, 'ERROR: Fold', fold_idx, 'left out sample', val_idx, '(expected', fold_idx, ')'
        all_correct = 0
    ENDIF
end
endfor

if all_correct then PRINT, 'LOO test PASSED ✓' ELSE PRINT, 'LOO test FAILED ✗'
PRINT, ''

; ============================================================================
; TEST 4: Practical Cross-Validation Example
; ============================================================================
PRINT, '--- TEST 4: Practical CV Example ---'
PRINT, 'Simulating model evaluation with 5-fold CV'

; Generate synthetic dataset
X_data = RANDOMU(seed, 100)
y_data = FLTARR(100)
for i = 0, 99 do begin
    IF X_data[i] gt 0.5 then y_data[i] = 1.0 ELSE y_data[i] = 0.0
end
endfor

; Create 5-fold CV
n_cv_folds = 5
cv_folds = XDLML_KFOLD(100, n_cv_folds, 42, 1)

; Simulate CV scores
cv_scores = FLTARR(n_cv_folds)

for fold_idx = 0, n_cv_folds-1 do begin
    fold_start = fold_idx * 100
    fold_end = fold_start + 99

    ; Extract training and validation indices
    train_indices = LONARR(100)
    val_indices = LONARR(100)
    n_train = 0
    n_val = 0

    FOR i = fold_start, fold_end do begin
        sample_idx = i - fold_start
        IF cv_folds[i] eq 1.0 then BEGIN
            train_indices[n_train] = sample_idx
            n_train = n_train + 1
        ENDIF ELSE BEGIN
            val_indices[n_val] = sample_idx
            n_val = n_val + 1
        ENDELSE
    END
endfor

    ; Trim arrays to actual size
    train_idx = train_indices[0:n_train-1]
    val_idx = val_indices[0:n_val-1]

    ; Simulate accuracy (in practice, train model and evaluate)
    ; For this test, just use a random accuracy
    cv_scores[fold_idx] = 0.80 + RANDOMU(seed) * 0.15

    PRINT, 'Fold', fold_idx, ': n_train=', n_train, ', n_val=', n_val, $
           ', accuracy=', cv_scores[fold_idx]
end
endfor

; Calculate mean and std of CV scores
mean_score = MEAN(cv_scores)
std_score = STDDEV(cv_scores)

PRINT, ''
PRINT, 'Mean CV Accuracy:', mean_score
PRINT, 'Std CV Accuracy:', std_score
PRINT, 'Practical CV example PASSED ✓'
PRINT, ''

; ============================================================================
; SUMMARY
; ============================================================================
PRINT, '========================================='
PRINT, 'Cross-Validation Tests Complete!'
PRINT, '========================================='
PRINT, '✓ K-Fold: Creates balanced train/val splits'
PRINT, '✓ Stratified K-Fold: Maintains class distribution'
PRINT, '✓ Leave-One-Out: Single-sample validation'
PRINT, '✓ Practical usage: Model evaluation workflow'
PRINT, ''
PRINT, 'All cross-validation utilities working correctly!'
